#include "oled.h"
#include "axigpio.h"
#include "axispi.h"
#include "utils.h"

uint8_t ascii_index;
uint8_t v_displayOn;

// Enciende el display OLED
void displayOn(void)
{
	if (v_displayOn)
		return;
	GPIO_3_DATA1_R = 0xFF;
	// GPIO[3:0] (VDD#[3], RES#[2], VBAT#[1], DC#[0])
	// Energiza Vdd con VDD# en bajo
	GPIO_3_DATA1_R &= ~0x08;
	// Espera 2 ms
	delay(2);
	// RES en bajo por 1ms
	GPIO_3_DATA1_R &= ~0x04;
	delay(1);
	// RES en alto, espera 1 ms
	GPIO_3_DATA1_R |= 0x04;
	// 1ms
	delay(1);
	// Energiza VBAT al poner en bajo
	GPIO_3_DATA1_R &= ~0x02;
	// Espera 100 ms
	delay(100);
	// Enciende el display con el comando 0xAF
	displaySendCommand(0xAF);

	v_displayOn = 1;
}

// Apaga el display
void displayOff(void)
{
	if (!v_displayOn)
		return;
	// Apaga el display con el comando 0xAE
	displaySendCommand(0xAE);
	// Apaga VBAT
	GPIO_3_DATA1_R |= 0x02;
	// Espera 100ms
	delay(100);
	// Apaga VDD
	GPIO_3_DATA1_R |= 0x08;

	v_displayOn = 0;
}

// Verifica si el display está encendido
uint8_t isDisplayOn(void)
{
	return v_displayOn;
}

// Envia un comando al display
void displaySendCommand(uint8_t cmd)
{
	GPIO_3_DATA1_R &= ~0x01;
	transmitSPI(cmd);
}

// Envia un dato al display
void displaySendData(uint8_t data)
{
	GPIO_3_DATA1_R |= 0x01;
	transmitSPI(data);
}

// Configura el display
void displayConfig(void)
{
	if (!v_displayOn)
		return;
	// Poner tasa de multiplexor a 64
	displaySendCommand(0xA8);
	displaySendCommand(0x3F);

	// Desfase en 0
	displaySendCommand(0xD3);
	displaySendCommand(0x00);

	// Linea de inicio del display
	displaySendCommand(0xA4);

	// Mapeo (La columna 0 se mapea al segmento 0 "SEG0")
	displaySendCommand(0xA0);

	// Modo de escaneo del COM0 al COM[N-1]
	displaySendCommand(0xC0);

	// Modo de escaneo secuencial, deshabilita remapeo
	displaySendCommand(0xDA);
	displaySendCommand(0x02);

	// Control del contraste
	displaySendCommand(0x81);
	displaySendCommand(0x7F);

	// Deshabilita encendido completo del display
	displaySendCommand(0xA4);

	// Display en modo normal/ 1 enciende, 0 apaga
	displaySendCommand(0xA6);

	// Frecuencia del oscilador, D(DCLK) = 8, D(FRM) = 1, DCLK = Fosc/D
	displaySendCommand(0xD5);
	displaySendCommand(0x80);

	// Habilita la bomba de carga de voltaje
	displaySendCommand(0x8D);
	displaySendCommand(0x14);

	// Modo de direccionamiento por página
	displaySendCommand(0x20);
	displaySendCommand(0x02);
}

// Establece una dirección en el display
void setDisplayAddress(uint8_t page, uint8_t column)
{
	// Dirección de la página
	displaySendCommand(0xB0 | (page & 0x0F));

	// Nibble alto de la dirección de la columna de inicio
	displaySendCommand(0x10 | (column>>4 & 0x0F));
	// Nibble bajo de la dirección de la columna de inicio
	displaySendCommand(0x0F & column);
}

// Escribe al display
void displayWrite(uint8_t data)
{
	displaySendData(data);
}

// Imprime un mensaje en el display
void displayPrint(uint8_t page, uint8_t col, const char *msg)
{
	if (!v_displayOn)
		return;
	setDisplayAddress(page, col);
	while(*msg)
	{
		ascii_index = (uint8_t)*msg++;
		uint8_t i;
		for (i = 7; i < 8; i--)
		{
			displayWrite(C[ascii_index][i]);
			// 10ms delay
			delay(10);
		}
	}
}

// Escribe un mensaje en el display por un tiempo determinado
void displayPrintTemp(uint8_t page, uint8_t col, const char *msg, uint32_t time)
{
	if (!v_displayOn)
		return;
	setDisplayAddress(page, col);
	while(*msg)
	{
		ascii_index = (uint8_t)*msg++;
		uint8_t i;
		for (i = 7; i < 8; i--)
		{
			displayWrite(C[ascii_index][i]);
			// Retardo de 10 us
			delayus(10);
		}
	}
	delay(time);
}

// Limpia el display
void clearDisplay(void)
{
	if (!v_displayOn)
		return;
	uint8_t i, j;
	for (i = 0; i < 4; i++)
	{
		setDisplayAddress(i, 0x00);
		for (j = 0; j < 128; j++)
		{
			displayWrite(0x00);
			// Retardo de 10 us
			delayus(10);
		}
	}
}

// Datos para crear caracteres ASCII 8x8
const uint8_t C[128][8] = {
	{0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0}, // Invalid
	{0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0}, // Invalid
	{0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0}, // Invalid
	{0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0}, // Invalid
	{0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0}, // Invalid
	{0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0}, // Invalid
	{0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0}, // Invalid
	{0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0}, // Invalid
	{0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0}, // Invalid
	{0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0}, // Invalid
	{0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0}, // Invalid
	{0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0}, // Invalid
	{0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0}, // Invalid
	{0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0}, // Invalid
	{0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0}, // Invalid
	{0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0}, // Invalid
	{0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0}, // Invalid
	{0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0}, // Invalid
	{0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0}, // Invalid
	{0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0}, // Invalid
	{0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0}, // Invalid
	{0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0}, // Invalid
	{0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0}, // Invalid
	{0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0}, // Invalid
	{0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0}, // Invalid
	{0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0}, // Invalid
	{0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0}, // Invalid
	{0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0}, // Invalid
	{0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0}, // Invalid
	{0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0}, // Invalid
	{0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0}, // Invalid
	{0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0}, // Invalid
	{0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0}, // Invalid
	{0x0, 0x0, 0x6, 0x5F, 0x5F, 0x6, 0x0, 0x0},			// Invalid
	{0x0, 0x0, 0x3, 0x3, 0x0, 0x3, 0x3, 0x0}, 			// Invalid
	{0x0, 0x14, 0x7F, 0x7F, 0x14, 0x7F, 0x7F, 0x14}, 	// Invalid
	{0x0, 0x0, 0x12, 0x3A, 0x6B, 0x6B, 0x2E, 0x24}, 	// Invalid
	{0x0, 0x62, 0x66, 0xC, 0x18, 0x30, 0x66, 0x46}, 	// Invalid
	{0x0, 0x48, 0x7A, 0x37, 0x5D, 0x4F, 0x7A, 0x30}, 	// Invalid
	{0x0, 0x0, 0x0, 0x0, 0x0, 0x3, 0x7, 0x4}, 			// Invalid
	{0x0, 0x0, 0x0, 0x41, 0x63, 0x3E, 0x1C, 0x0}, 		// Invalid
	{0x0, 0x0, 0x0, 0x1C, 0x3E, 0x63, 0x41, 0x0}, 		// Invalid
	{0x8, 0x2A, 0x3E, 0x1C, 0x1C, 0x3E, 0x2A, 0x8}, 	// Invalid
	{0x0, 0x0, 0x8, 0x8, 0x3E, 0x3E, 0x8, 0x8}, 		// Invalid
	{0x0, 0x0, 0x0, 0x0, 0x60, 0xE0, 0x80, 0x0}, 		// Invalid
	{0x0, 0x0, 0x8, 0x8, 0x8, 0x8, 0x8, 0x8}, 			// Invalid
	{0x0, 0x0, 0x0, 0x0, 0x60, 0x60, 0x0, 0x0}, 		// Invalid
	{0x0, 0x1, 0x3, 0x6, 0xC, 0x18, 0x30, 0x60},		// Invalid
	{0x0, 0x3E, 0x7F, 0x4D, 0x59, 0x71, 0x7F, 0x3E},	// 0
	{0x0, 0x0, 0x40, 0x40, 0x7F, 0x7F, 0x42, 0x40}, 	// 1
	{0x0, 0x0, 0x66, 0x6F, 0x49, 0x59, 0x73, 0x62}, 	// 2
	{0x0, 0x0, 0x36, 0x7F, 0x49, 0x49, 0x63, 0x22}, 	// 3
	{0x0, 0x50, 0x7F, 0x7F, 0x53, 0x16, 0x1C, 0x18}, 	// 4
	{0x0, 0x0, 0x39, 0x7D, 0x45, 0x45, 0x67, 0x27}, 	// 5
	{0x0, 0x0, 0x30, 0x79, 0x49, 0x4B, 0x7E, 0x3C}, 	// 6
	{0x0, 0x0, 0x7, 0xF, 0x79, 0x71, 0x3, 0x3}, 		// 7
	{0x0, 0x0, 0x36, 0x7F, 0x49, 0x49, 0x7F, 0x36}, 	// 8
	{0x0, 0x0, 0x1E, 0x3F, 0x69, 0x49, 0x4F, 0x6}, 		// 9
	{0x0, 0x0, 0x0, 0x0, 0x66, 0x66, 0x0, 0x0}, 		// Invalid
	{0x0, 0x0, 0x0, 0x0, 0x66, 0xE6, 0x80, 0x0}, 		// Invalid
	{0x0, 0x0, 0x0, 0x41, 0x63, 0x36, 0x1C, 0x8}, 		// Invalid
	{0x0, 0x0, 0x24, 0x24, 0x24, 0x24, 0x24, 0x24}, 	// Invalid
	{0x0, 0x0, 0x8, 0x1C, 0x36, 0x63, 0x41, 0x0}, 		// Invalid
	{0x0, 0x0, 0x6, 0xF, 0x59, 0x51, 0x3, 0x2}, 		// Invalid
	{0x0, 0x1E, 0x1F, 0x5D, 0x5D, 0x41, 0x7F, 0x3E}, 	// Invalid
	{0x0, 0x0, 0x7C, 0x7E, 0x13, 0x13, 0x7E, 0x7C}, 	// A
	{0x0, 0x36, 0x7F, 0x49, 0x49, 0x7F, 0x7F, 0x41}, 	// B
	{0x0, 0x22, 0x63, 0x41, 0x41, 0x63, 0x3E, 0x1C}, 	// C
	{0x0, 0x1C, 0x3E, 0x63, 0x41, 0x7F, 0x7F, 0x41}, 	// D
	{0x0, 0x63, 0x41, 0x5D, 0x49, 0x7F, 0x7F, 0x41}, 	// E
	{0x0, 0x3, 0x1, 0x1D, 0x49, 0x7F, 0x7F, 0x41}, 		// F
	{0x0, 0x72, 0x73, 0x51, 0x41, 0x63, 0x3E, 0x1C}, 	// G
	{0x0, 0x0, 0x7F, 0x7F, 0x8, 0x8, 0x7F, 0x7F}, 		// H
	{0x0, 0x0, 0x0, 0x41, 0x7F, 0x7F, 0x41, 0x0}, 		// I
	{0x0, 0x1, 0x3F, 0x7F, 0x41, 0x40, 0x70, 0x30}, 	// J
	{0x0, 0x63, 0x77, 0x1C, 0x8, 0x7F, 0x7F, 0x41}, 	// K
	{0x0, 0x70, 0x60, 0x40, 0x41, 0x7F, 0x7F, 0x41}, 	// L
	{0x0, 0x7F, 0x7F, 0xE, 0x1C, 0xE, 0x7F, 0x7F}, 		// M
	{0x0, 0x7F, 0x7F, 0x18, 0xC, 0x6, 0x7F, 0x7F}, 		// N
	{0x0, 0x1C, 0x3E, 0x63, 0x41, 0x63, 0x3E, 0x1C}, 	// O
	{0x0, 0x6, 0xF, 0x9, 0x49, 0x7F, 0x7F, 0x41}, 		// P
	{0x0, 0x0, 0x5E, 0x7F, 0x71, 0x21, 0x3F, 0x1E}, 	// Q
	{0x0, 0x66, 0x7F, 0x19, 0x9, 0x7F, 0x7F, 0x41}, 	// R
	{0x0, 0x0, 0x32, 0x73, 0x59, 0x4D, 0x6F, 0x26}, 	// S
	{0x0, 0x0, 0x3, 0x41, 0x7F, 0x7F, 0x41, 0x3}, 		// T
	{0x0, 0x0, 0x7F, 0x7F, 0x40, 0x40, 0x7F, 0x7F}, 	// U
	{0x0, 0x0, 0x1F, 0x3F, 0x60, 0x60, 0x3F, 0x1F}, 	// V
	{0x0, 0x7F, 0x7F, 0x30, 0x18, 0x30, 0x7F, 0x7F}, 	// W
	{0x0, 0x43, 0x67, 0x3C, 0x18, 0x3C, 0x67, 0x43}, 	// X
	{0x0, 0x0, 0x7, 0x4F, 0x78, 0x78, 0x4F, 0x7}, 		// Y
	{0x0, 0x73, 0x67, 0x4D, 0x59, 0x71, 0x63, 0x47}, 	// Z
	{0x0, 0x0, 0x0, 0x41, 0x41, 0x7F, 0x7F, 0x0}, 		// Invalid
	{0x0, 0x60, 0x30, 0x18, 0xC, 0x6, 0x3, 0x1}, 		// Invalid
	{0x0, 0x0, 0x0, 0x7F, 0x7F, 0x41, 0x41, 0x0}, 		// Invalid
	{0x0, 0x8, 0xC, 0x6, 0x3, 0x6, 0xC, 0x8}, 			// Invalid
	{0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80}, 	// Invalid
	{0x0, 0x0, 0x0, 0x4, 0x7, 0x3, 0x0, 0x0}, 			// Invalid
	{0x0, 0x40, 0x78, 0x3C, 0x54, 0x54, 0x74, 0x20}, 	// a
	{0x0, 0x30, 0x78, 0x48, 0x48, 0x3F, 0x7F, 0x41}, 	// b
	{0x0, 0x0, 0x28, 0x6C, 0x44, 0x44, 0x7C, 0x38}, 	// c
	{0x0, 0x40, 0x7F, 0x3F, 0x49, 0x48, 0x78, 0x30}, 	// d
	{0x0, 0x0, 0x18, 0x5C, 0x54, 0x54, 0x7C, 0x38}, 	// e
	{0x0, 0x0, 0x2, 0x3, 0x49, 0x7F, 0x7E, 0x48}, 		// f
	{0x0, 0x4, 0x7C, 0xF8, 0xA4, 0xA4, 0xBC, 0x98}, 	// g
	{0x0, 0x78, 0x7C, 0x4, 0x8, 0x7F, 0x7F, 0x41}, 		// h
	{0x0, 0x0, 0x0, 0x40, 0x7D, 0x7D, 0x44, 0x0}, 		// i
	{0x0, 0x0, 0x7D, 0xFD, 0x80, 0x80, 0xE0, 0x60}, 	// j
	{0x0, 0x44, 0x6C, 0x38, 0x10, 0x7F, 0x7F, 0x41}, 	// k
	{0x0, 0x0, 0x0, 0x40, 0x7F, 0x7F, 0x41, 0x0}, 		// l
	{0x0, 0x78, 0x7C, 0x1C, 0x38, 0x18, 0x7C, 0x7C}, 	// m
	{0x0, 0x0, 0x78, 0x7C, 0x4, 0x4, 0x7C, 0x7C}, 		// n
	{0x0, 0x0, 0x38, 0x7C, 0x44, 0x44, 0x7C, 0x38}, 	// o
	{0x0, 0x18, 0x3C, 0x24, 0xA4, 0xF8, 0xFC, 0x84}, 	// p
	{0x0, 0x84, 0xFC, 0xF8, 0xA4, 0x24, 0x3C, 0x18}, 	// q
	{0x0, 0x18, 0x1C, 0x4, 0x4C, 0x78, 0x7C, 0x44}, 	// r
	{0x0, 0x0, 0x24, 0x74, 0x54, 0x54, 0x5C, 0x48}, 	// s
	{0x0, 0x0, 0x24, 0x44, 0x7F, 0x3E, 0x4, 0x0}, 		// t
	{0x0, 0x40, 0x7C, 0x3C, 0x40, 0x40, 0x7C, 0x3C}, 	// u
	{0x0, 0x0, 0x1C, 0x3C, 0x60, 0x60, 0x3C, 0x1C}, 	// v
	{0x0, 0x3C, 0x7C, 0x70, 0x38, 0x70, 0x7C, 0x3C}, 	// w
	{0x0, 0x44, 0x6C, 0x38, 0x10, 0x38, 0x6C, 0x44}, 	// x
	{0x0, 0x0, 0x7C, 0xFC, 0xA0, 0xA0, 0xBC, 0x9C}, 	// y
	{0x0, 0x0, 0x64, 0x4C, 0x5C, 0x74, 0x64, 0x4C}, 	// z
	{0x0, 0x0, 0x41, 0x41, 0x77, 0x3E, 0x8, 0x8}, 		// Invalid
	{0x0, 0x0, 0x0, 0x77, 0x77, 0x0, 0x0, 0x0}, 		// Invalid
	{0x0, 0x0, 0x8, 0x8, 0x3E, 0x77, 0x41, 0x41}, 		// Invalid
	{0x0, 0x1, 0x3, 0x2, 0x3, 0x1, 0x3, 0x2}, 			// Invalid
	{0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0} 			// Invalid
};
